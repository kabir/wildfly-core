name: Dependency Tree Reporter
# This gets called when ./dep-diff-pull_request.yml has completed. See that file
# for why this is split into two.
on:
  workflow_run:
    workflows: [ "Dependency Tree Input Builder" ]
    types:
      - completed
env:
  # The name of the labels to use if the dependencies are ok
  DEPS_OK_LABEL_NAME: deps-ok
  # The name of the labels to use if the dependencies changed
  DEPS_CHANGED_LABEL_NAME: deps-changed
  # People/teams to mention in the PR comment if dependencies changed
  CHANGE_MENTIONS: '@wildfly/prod'
jobs:
  compare:
    runs-on: ubuntu-latest
    if: >
      ${{ github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v2
        with:
          name: input-artifacts
          path: .

      - name: Set needed env vars in outputs
        id: prepare
        run: |
          echo current directory contents
          ls -al
          echo "::set-output name=deps_ok_label_name::${DEPS_OK_LABEL_NAME}"
          echo "::set-output name=deps_changed_label_name::${DEPS_CHANGED_LABEL_NAME}"
          echo "::set-output name=change_mentions::${CHANGE_MENTIONS}"


      - name: Check versions
        uses: wildfly/dep-tree-diff@master
        with:
          token: '${{ secrets.GITHUB_TOKEN }}'
          deps-ok-label: ${{ steps.prepare.outputs.deps_ok_label_name }}
          deps-changed-label: ${{ steps.prepare.outputs.deps_changed_label_name }}
          tool-change-mentions: ${{ steps.prepare.outputs.change_mentions }}
          base-version-files: ${{ steps.base-versions.outputs.files }}
          new-version-files: ${{ steps.new-versions.outputs.files }}
